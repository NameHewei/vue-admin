<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>双向绑定</title>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
</head>
<body>
    <p class="a" v-model="123">Observe 监听器 监听属性变化并通知订阅者</p>
    <p>Watch 订阅者 收到属性变化，更新视图</p>
    <p>compile 解析器 解析指令，初始化模板，绑定订阅者 </p>
    <div id="app">{{ name }}</div>
    <script>
        const vue = new Vue({
            data: {
                name: 'hew',
                obj: {
                    score: 90
                }
            },

            created() {
                console.log(this.obj);
            }
        })

        const testObj = {
            name: 'hew',
            score: {
                chinese: 123,
                math: 234
            }
        }

        const defineProp = function(obj, key, value) {
            // 递归对象，直到value是值类型
            observe(value)

            const dep = new Dep()

            Object.defineProperty(obj, key, {
                get: function() {
                    console.log('监听',key);
                    if(Dep.target) {
                        dep.addSub(Dep.target)
                    }
                    return value
                },
                set: function(newVal) {
                    if(newVal !== value) {
                        console.log('set新值', key, newVal);
                        value = newVal
                        // 通知所有订阅者
                        dep.notify()
                    }

                }
            })
        }

        const observe = function(obj) {
            if(!obj || typeof obj !== 'object') return

            Object.keys(obj).forEach(function(key) {
                defineProp(obj, key, obj[key])
            })
        }

        // observe(testObj)


        function Dep() {
            this.subs = []
        }
        Dep.prototype.addSub = function(sub) {
            this.subs.push(sub)
        }
        Dep.prototype.notify = function(sub) {
            this.subs.forEach(sub => {
                sub.update()
            })
        }
        Dep.target = null

        // observe(testObj)
        // testObj.name = 'hewei'

        function Watcher(vm, prop, callback) {
            this.vm = vm
            this.prop = prop
            this.callback = callback
            this.value = this.get()
        }

        Watcher.prototype = {
            update: function() {
                const value = this.vm.$data[this.prop]
                const oldValue = this.value
                if (value !== oldValue) {
                    this.value = value
                    this.callback(value)
                }
            },
            get: function() {
                // 存贮订阅器
                Dep.target = this
                // 触发对象的get监听，将上面赋值给targe的this 加入到subs
                var value = this.vm.$data[this.prop]
                // 加入完后就删除
                Dep.target = null
                return value
            }
        }

        function Mvue(options, prop) {
            this.$options = options
            this.$data = options.data
            this.$prop = prop
            this.$el = document.querySelector(options.el)
            this.init()
        }
        Mvue.prototype.init = function() {
            observe(this.$data)
            this.$el.textContent = this.$data[this.$prop]
            new Watcher(this, this.$prop, value => {
                this.$el.textContent = value
            })
        }

        function Compile(vm) {
           this.vm = vm
           this.el = vm.$el
           this.fragment = null
           this.init()
        }
        Compile.prototype = {
            init: function() {
                this.fragment = this.nodeFragment(this.el)
                
            },
            nodeFragment: function() {
                const fragment = document.createDocumentFragment()
                let child = el.firstChild

                while(child) {
                    fragment.appendChild(child)
                    child = el.firstChild
                }

                return fragment
            },

            compileNode: function(fragment) {
                let childNodes = fragment.childNodes;
                [...childNodes].forEach(node =>{
                    if(this.isElementNode(node)) {
                        this.compile(node)
                    }

                    // 匹配{{}}
                    let reg = /\{\{(.*)\}\}/
                    // 获取节点的文本内容
                    let text = node.textContent

                    // 判断文本内容是否有{{}}
                    if(reg.test(text)) {
                        let prop = reg.exec(text)[1]
                        this.compileText(node, prop)
                    }

                    // length 为0 表示没有子元素并且没有文本
                    if(node.childNodes && node.childNodes.length) {
                        // 递归编译子子节点
                        this.compileNode(node)
                    }
                })
            },

            compile: function() {
                // 获取属性
                let nodeAttrs = node.attributes;
                [...nodeAttrs].forEach(attr => {
                    // 这里有疑惑
                    let name = attr.name

                    if(this.isDirective(name)) {
                        let value = attr.value
                        if (name === 'v-model') {
                            this.compileModel(node, value)
                        }
                    }
                })
            },

            compileModel: function(node, prop) {
                let val = this.vm.$data[prop]
                this.updateModel(node, val)

                new Watcher(this.vm, prop, value => {
                    this.updateModel(node, value)
                })

                node.addEventListener('input', event => {
                    let newValue = event.target.value
                    if (val === newValue) return
                    this.vm.$data[prop] = newValue
                })
            },

            compileText: function(node, prop) {
                let text = this.vm.$data[prop]
                this.updateView(node, text)

                new Watcher(this.vm, prop, (value) => {
                    this.updateView(node, value)
                })
            },

            isDirective: function (text) {
                return /v-/.test(text)
            },

            isElementNode: function(node) {
                // 元素节点返回1 文本节点(元素或属性中的文字)3 属性节点2(被废弃)
                return node.nodeType === 1
            },

            isTextNode: function(node) {
                return node.nodeType === 3
            },

            updateModel: function(node, value) {
                // 这里有疑问
                node.value = value || ''
            },

            updateView: function(node, value) {
                node.textContent = value || ''
            }
        }

        var compileUtil = {
            text: function(node, vm, exp) {
                this.bind(node, vm, exp, 'text');
            }
        }

        // const vm = new Mvue({
        //     el: '#app',
        //     data: {
        //         name: '完全没问题，看起来是不是很酷'
        //     }
        // }, 'name')

        const vm = new Mvue({
            el: "#app",
            data: {
                name: "完全没问题，看起来是不是很酷！"
            }
        });
    </script>
</body>
</html>
